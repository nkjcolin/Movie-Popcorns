<style>
#card-container {
    display: flex;
    flex-wrap: wrap;
}

.card {
    width: calc((100% / 3) - 16px);
    border-radius: 3px;
    transition: all 200ms ease-in-out;
    display: flex;
}

.card:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.card-actions {
    margin: 8px;
    padding: 16px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#loader {
    display: flex;
}

.skeleton-card {
    height: 25vh;
    width: calc((100% / 3) - 16px);
    margin: 8px;
    border-radius: 3px;
    transition: all 200ms ease-in-out;
    position: relative;
    background-color: #424242;
}

.skeleton-card::after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    transform: translateX(-100%);
    background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.2) 20%, rgba(255, 255, 255, 0.11) 60%, rgba(255, 255, 255, 0));
    animation: load 2s infinite;
}

@keyframes load {
    5% {
    transform: translateX(5%);
    }
}

@media screen and (prefers-reduced-motion: reduce) {
    .skeleton-card::after {
    animation: none;
    }
}

</style>
    
{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
<div class="content">
    <h2>You searched for: {{ searchedTitle }}</h2>
    <div id="card-container"></div>

    <!-- <div id="loader">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
    </div> -->
    
    <div class="card-actions">
        <span>Showing <span id="card-count"></span> of <span id="card-total"></span> movies</span>
    </div>
</div>
        
<!-- FUNCTION FOR INFINITE SCROLLING-->

<script>
    const cardContainer = document.getElementById("card-container");
    const cardCountElem = document.getElementById("card-count");
    const cardTotalElem = document.getElementById("card-total");
    const loader = document.getElementById("loader");

    const movies = JSON.parse('{{ moviesJson|safe }}');
    
    const cardLimit = movies.length;
    const cardIncrease = 15; // display 15 per page
    const pageCount = Math.ceil(cardLimit / cardIncrease);
    let currentPage = 1;

    cardTotalElem.innerHTML = cardLimit;

    var throttleTimer;
    const throttle = (callback, time) => {
        if (throttleTimer) return;

        throttleTimer = true;

        setTimeout(() => {
            callback();
            throttleTimer = false;
        }, time);
    };

    const addCards = (pageIndex) => {
        currentPage = pageIndex;

        const startRange = (pageIndex - 1) * cardIncrease;
        const endRange = currentPage === pageCount ? cardLimit : pageIndex * cardIncrease;

        cardCountElem.innerHTML = endRange;

        for (let i = startRange + 1; i <= endRange; i++) {
            createCard(movies[i-1])
        };
    };

    const createCard = (movie) => {
        const cardHTML = `
            <div class="card card-chart">
                <div class="card-header">
                    <h3 class="card-title">${movie.name}</h3>
                </div>
                <div class="card-body">
                    <div class="row" style="margin-right: 1px;">
                        <div class="col-5">
                            <img src="${movie.imageSrc}">
                        </div>
                        <div class="col-7">
                            <h4><b>Rating:</b> ${movie.rating}</h4>
                            <h4>${movie.runtime} mins</h4>
                            <p>${movie.description}</p>
                        </div>
                    </div>
                </div>
                <a href="/movie/${movie.titleID}" class="btn btn-primary">
                    <p>Read More</p>
                </a>
            </div>
        `;

        var cardElement = document.createElement('div');
        cardElement.className = 'col-lg-4';
        cardElement.innerHTML = cardHTML;
        cardContainer.appendChild(cardElement);
    }
    
    const handleInfiniteScroll = () => {
        throttle(() => {
            const endOfPage = window.innerHeight + window.pageYOffset >= document.body.offsetHeight;

            if (endOfPage) {
                addCards(currentPage + 1);
            }

            if (currentPage === pageCount) {
                removeInfiniteScroll();
            }
        }, 1000);
    };

    const removeInfiniteScroll = () => {
        loader.remove();
        window.removeEventListener("scroll", handleInfiniteScroll);
    };

    window.addEventListener("scroll", handleInfiniteScroll);

    addCards(1);
</script>
    
{% endblock content %}